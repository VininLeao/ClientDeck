<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClientDeck - Gerenciador de Clientes</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            padding: 15px;
            font-size: 14px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #58a6ff, #f78166, #a5a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            color: #8b949e;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 20px;
            background: linear-gradient(135deg, #161b22, #1c2128);
            border-radius: 12px;
            border: 1px solid #30363d;
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            min-width: 120px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }

        .stat-item.todo {
            background: rgba(248, 81, 73, 0.08);
            border: 1px solid rgba(248, 81, 73, 0.2);
        }

        .stat-item.todo::before {
            background: linear-gradient(90deg, #f85149, #ff6b6b);
        }

        .stat-item.progress {
            background: rgba(210, 153, 34, 0.08);
            border: 1px solid rgba(210, 153, 34, 0.2);
        }

        .stat-item.progress::before {
            background: linear-gradient(90deg, #d29922, #ffc107);
        }

        .stat-item.done {
            background: rgba(63, 185, 80, 0.08);
            border: 1px solid rgba(63, 185, 80, 0.2);
        }

        .stat-item.done::before {
            background: linear-gradient(90deg, #3fb950, #56d364);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            display: block;
            margin-bottom: 4px;
        }

        .stat-item.todo .stat-number {
            background: linear-gradient(135deg, #f85149, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-item.progress .stat-number {
            background: linear-gradient(135deg, #d29922, #ffc107);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-item.done .stat-number {
            background: linear-gradient(135deg, #3fb950, #56d364);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #8b949e;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .stat-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .search-box {
            margin-bottom: 20px;
            position: relative;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #f0f6fc;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
            background: #161b22;
        }

        .search-box .clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .search-box .clear-search:hover {
            color: #f0f6fc;
            background: #30363d;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #161b22, #1c2128);
            border: 1px solid #30363d;
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .controls-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .controls-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #2ea043;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: #2ea043;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(46, 160, 67, 0.3);
        }

        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
        }

        .btn-secondary:hover {
            background: #30363d;
            border-color: #8b949e;
            box-shadow: 0 6px 20px rgba(48, 54, 61, 0.3);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
        }

        .btn-ghost:hover {
            background: #21262d;
            border-color: #58a6ff;
            color: #f0f6fc;
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.2);
        }

        .btn-ghost-danger {
            background: transparent;
            border: 1px solid #da3633;
            color: #da3633;
        }

        .btn-ghost-danger:hover {
            background: #da3633;
            border-color: #f85149;
            color: white;
            box-shadow: 0 4px 15px rgba(218, 54, 51, 0.3);
        }

        .btn-danger {
            background: #da3633;
            border: 1px solid #f85149;
        }

        .btn-danger:hover {
            background: #f85149;
            box-shadow: 0 6px 20px rgba(248, 81, 73, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-mini {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .btn-mini.btn-save {
            background: #238636;
            border-color: #2ea043;
            color: white;
        }

        .btn-mini.btn-save:hover {
            background: #2ea043;
            border-color: #3fb950;
            box-shadow: 0 4px 15px rgba(46, 160, 67, 0.4);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: #0d1117;
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 1px solid #30363d;
            border-radius: 8px;
            z-index: 1000;
            top: 100%;
            left: 0;
            margin-top: 4px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            color: #e6edf3;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: #21262d;
            color: #58a6ff;
        }

        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .dropdown-arrow {
            transition: transform 0.3s ease;
        }

        .dropdown-btn.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .filter-label {
            color: #f0f6fc;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .filter-dropdown {
            min-width: 180px;
            padding: 8px 12px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #f0f6fc;
            font-size: 14px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238b949e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 35px;
            transition: all 0.3s ease;
        }

        .filter-dropdown:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
            background-color: #161b22;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto 30px auto;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8b949e;
            font-size: 0.9rem;
            font-style: italic;
        }

        .table-view {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #161b22, #1c2128);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }

        .table-view.hidden {
            display: none;
        }

        .table-view table {
            width: 100%;
            border-collapse: collapse;
            background: #0d1117;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-view th,
        .table-view td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }

        .table-view th {
            background: #21262d;
            color: #f0f6fc;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .table-view td {
            color: #e6edf3;
            font-size: 0.85rem;
        }

        .table-view tr:hover {
            background: #161b22;
        }

        .client-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .client-row:hover {
            background: #161b22;
        }

        .detail-row {
            display: none;
            background: #0d1117;
            transition: all 0.3s ease;
        }

        .detail-row.expanded {
            display: table-row;
        }

        .detail-row td {
            padding: 16px;
            border-left: 3px solid #58a6ff;
            background: #0a0f16;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .detail-row td:hover {
            background: #0f1419;
        }

        .detail-row.editing {
            border-left: 3px solid #f78166;
            background: #1a0e0a;
        }

        .detail-row.editing td {
            background: #1a0e0a;
            border-left: 3px solid #f78166;
        }

        .detail-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 16px;
            align-items: flex-start;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 3px;
            transition: all 0.2s ease;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .expand-btn.expanded {
            color: #58a6ff;
        }

        .checklist-question {
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .checklist-answer {
            color: #8b949e;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .checklist-answer:hover {
            background: #21262d;
        }

        .checklist-answer.completed {
            color: #56d364;
        }

        .checklist-answer.incomplete {
            color: #ff6b6b;
        }

        .inline-edit-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .inline-edit {
            background: #21262d;
            border: 1px solid #58a6ff;
            color: #f0f6fc;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 100%;
            max-width: 250px;
            transition: all 0.3s ease;
        }

        .inline-edit:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
            border-color: #79c0ff;
        }

        .inline-edit-select {
            background: #21262d;
            border: 1px solid #58a6ff;
            color: #f0f6fc;
            padding: 6px 30px 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 100%;
            max-width: 250px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2358a6ff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            transition: all 0.3s ease;
        }

        .inline-edit-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3);
            border-color: #79c0ff;
        }

        .inline-edit-checkbox {
            transform: scale(1.3);
            accent-color: #58a6ff;
        }

        .editing-indicator {
            display: inline-block;
            font-size: 0.7rem;
            color: #f78166;
            margin-left: 8px;
            font-style: italic;
        }

        .last-edited {
            font-size: 0.7rem;
            color: #8b949e;
            margin-top: 4px;
            font-style: italic;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
            display: inline-block;
        }

        .status-todo {
            background: rgba(248, 81, 73, 0.1);
            color: #ff6b6b;
            border: 1px solid #f85149;
        }

        .status-progress {
            background: rgba(210, 153, 34, 0.1);
            color: #ffc107;
            border: 1px solid #d29922;
        }

        .status-done {
            background: rgba(63, 185, 80, 0.1);
            color: #56d364;
            border: 1px solid #3fb950;
        }

        .progress-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-bar-mini {
            flex: 1;
            background: #21262d;
            border-radius: 4px;
            height: 4px;
            overflow: hidden;
        }

        .progress-fill-mini {
            background: linear-gradient(90deg, #3fb950, #56d364);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .column {
            background: linear-gradient(135deg, #161b22, #1c2128);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            min-height: 550px;
            position: relative;
            overflow: hidden;
        }

        .column::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }

        .todo::before {
            background: linear-gradient(90deg, #f85149, #ff6b6b);
        }

        .progress::before {
            background: linear-gradient(90deg, #d29922, #ffc107);
        }

        .done::before {
            background: linear-gradient(90deg, #3fb950, #56d364);
        }

        .column h2 {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            border: 1px solid;
            position: relative;
            overflow: hidden;
        }

        .todo h2 {
            background: rgba(248, 81, 73, 0.1);
            border-color: #f85149;
            color: #ff6b6b;
        }

        .progress h2 {
            background: rgba(210, 153, 34, 0.1);
            border-color: #d29922;
            color: #ffc107;
        }

        .done h2 {
            background: rgba(63, 185, 80, 0.1);
            border-color: #3fb950;
            color: #56d364;
        }

        .card {
            background: linear-gradient(135deg, #0d1117, #161b22);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(135deg, #58a6ff, #a5a5f5);
        }

        .card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.15);
        }

        .card.dragging {
            opacity: 0.7;
            transform: rotate(2deg) scale(0.95);
            box-shadow: 0 10px 35px rgba(0,0,0,0.4);
        }

        .card h3 {
            color: #f0f6fc;
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: 600;
        }

        .card .template-name {
            color: #8b949e;
            font-size: 0.8rem;
            margin-bottom: 12px;
            background: #21262d;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .card .progress-bar {
            background: #21262d;
            border-radius: 8px;
            height: 6px;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1px solid #30363d;
        }

        .card .progress-fill {
            background: linear-gradient(90deg, #3fb950, #56d364);
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
            position: relative;
        }

        .card .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .card .progress-text {
            font-size: 0.75rem;
            color: #8b949e;
            text-align: right;
            font-weight: 500;
        }

        .card .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #30363d;
            font-size: 0.7rem;
            color: #8b949e;
            flex-wrap: wrap;
            gap: 4px;
        }

        .card .dates-info {
            font-size: 0.65rem;
            color: #8b949e;
            margin-top: 6px;
            line-height: 1.2;
        }

        .column.drag-over {
            border-color: #58a6ff;
            background: linear-gradient(135deg, #0c2d6b, #1c2128);
            transform: scale(1.01);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: #0d1117;
            border: 1px solid #30363d;
            margin: 30px auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }

        .modal-header h2 {
            color: #f0f6fc;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .close {
            color: #8b949e;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 6px;
            border-radius: 6px;
            line-height: 1;
        }

        .close:hover {
            color: #f0f6fc;
            background: #30363d;
            transform: scale(1.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #30363d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #f0f6fc;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            font-size: 14px;
            color: #f0f6fc;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
            background: #161b22;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #8b949e;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-group select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238b949e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .checklist-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            border-color: #58a6ff;
        }

        .checklist-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #f0f6fc;
            font-size: 0.9rem;
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
            accent-color: #3fb950;
        }

        .checklist-item textarea,
        .checklist-item input[type="text"],
        .checklist-item input[type="date"],
        .checklist-item input[type="number"],
        .checklist-item input[type="url"] {
            margin-top: 10px;
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
        }

        .checklist-item textarea:focus,
        .checklist-item input[type="text"]:focus,
        .checklist-item input[type="date"]:focus,
        .checklist-item input[type="number"]:focus,
        .checklist-item input[type="url"]:focus {
            border-color: #58a6ff;
            background: #161b22;
        }

        .tab-container {
            margin-bottom: 25px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            color: #8b949e;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            color: #58a6ff;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #58a6ff;
        }

        .tab-button:hover:not(.active) {
            color: #f0f6fc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .template-builder {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .template-builder h3 {
            color: #f0f6fc;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .template-items-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            background: #0d1117;
        }

        .template-question-block {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .template-question-block:hover {
            border-color: #58a6ff;
        }

        .template-remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #da3633;
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .template-remove-btn:hover {
            background: #f85149;
            transform: scale(1.1);
        }

        .template-item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-bottom: 12px;
            padding-right: 40px;
        }

        .template-item input[type="text"] {
            flex: 1;
            min-width: 250px;
            padding: 10px 12px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            color: #f0f6fc;
            transition: all 0.3s ease;
        }

        .template-item input[type="text"]:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
            background: #161b22;
        }

        .template-item input[type="text"]::placeholder {
            color: #8b949e;
        }

        .template-item input[type="text"]:disabled {
            background: #0d1117;
            color: #8b949e;
            cursor: not-allowed;
        }

        .template-item select {
            min-width: 180px;
            padding: 10px 35px 10px 12px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            color: #f0f6fc;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238b949e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            transition: all 0.3s ease;
        }

        .template-item select:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
            background-color: #161b22;
        }

        .template-item-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            width: 100%;
        }

        .template-item .options-input {
            width: 100%;
            margin-top: 8px;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 12px;
            color: #f0f6fc;
            transition: all 0.3s ease;
        }

        .template-item .options-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
        }

        .template-item .required-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8b949e;
            font-size: 12px;
            white-space: nowrap;
        }

        .template-item .required-checkbox input[type="checkbox"] {
            transform: scale(1.1);
            accent-color: #f85149;
        }

        .drag-handle {
            color: #8b949e;
            cursor: grab;
            font-size: 14px;
            transition: color 0.2s ease;
            user-select: none;
        }

        .drag-handle:hover {
            color: #f0f6fc;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .sortable-ghost {
            opacity: 0.4;
        }

        .templates-list {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .template-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .template-card:hover {
            border-color: #58a6ff;
            transform: translateY(-1px);
        }

        .template-card.selected {
            border-color: #3fb950;
            background: linear-gradient(135deg, #0f2419, #1c2128);
        }

        .template-card h4 {
            color: #f0f6fc;
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .template-card p {
            color: #8b949e;
            font-size: 0.8rem;
        }

        .template-card .template-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #238636, #2ea043);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #2ea043;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.4s ease;
            box-shadow: 0 10px 35px rgba(35, 134, 54, 0.3);
            font-weight: 600;
            font-size: 14px;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: linear-gradient(135deg, #da3633, #f85149);
            border-color: #f85149;
            box-shadow: 0 10px 35px rgba(218, 54, 51, 0.3);
        }

        .keyboard-shortcut {
            font-size: 0.75rem;
            color: #8b949e;
            margin-top: 8px;
            text-align: center;
            padding: 6px;
            background: #21262d;
            border-radius: 4px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #30363d;
            border-radius: 50%;
            border-top-color: #58a6ff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            border-top: 1px solid #30363d;
            color: #8b949e;
            font-size: 0.85rem;
        }

        .footer a {
            color: #58a6ff;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .footer a:hover {
            color: #79c0ff;
        }

        @media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .modal-content {
                margin: 15px auto;
                width: 95%;
                max-height: 90vh;
                padding: 20px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-left,
            .controls-right {
                width: 100%;
                justify-content: center;
            }

            .stats {
                flex-direction: column;
                gap: 12px;
            }

            .modal-actions {
                flex-direction: column;
            }

            .template-item {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
                padding-right: 15px;
            }

            .template-item select {
                min-width: auto;
                width: 100%;
            }

            .template-item-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .card .card-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .table-view {
                padding: 10px;
            }

            .table-view table {
                font-size: 0.75rem;
            }

            .table-view th,
            .table-view td {
                padding: 8px 12px;
            }

            .detail-content {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .filter-dropdown {
                min-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>✨ ClientDeck</h1>
        <p>O jeito mais simples e intuitivo de gerenciar seus clientes</p>
    </div>

    <div class="stats">
        <div class="stat-item todo">
            <span class="stat-number" id="todoCount">0</span>
            <span class="stat-label">
                <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                A Fazer
            </span>
        </div>
        <div class="stat-item progress">
            <span class="stat-number" id="progressCount">0</span>
            <span class="stat-label">
                <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                Em Andamento
            </span>
        </div>
        <div class="stat-item done">
            <span class="stat-number" id="doneCount">0</span>
            <span class="stat-label">
                <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                Concluído
            </span>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="🔍 Buscar clientes... (digite o nome ou template)">
        <button class="clear-search" onclick="clearSearch()" style="display: none;">×</button>
    </div>

    <div class="controls">
        <div class="controls-left">
            <button class="btn" onclick="openNewClientModal()">
                <span>👤</span> Novo Cliente
            </button>
            
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-btn" id="actionsDropdownBtn" onclick="toggleDropdown('actionsDropdown')">
                    <span>⚙️</span> Ações <span class="dropdown-arrow">▼</span>
                </button>
                <div id="actionsDropdown" class="dropdown-content">
                    <button class="dropdown-item" onclick="openTemplateModal(); closeDropdown('actionsDropdown')">
                        <span>📋</span> Templates
                    </button>
                    <button class="dropdown-item" onclick="exportData(); closeDropdown('actionsDropdown')">
                        <span>📥</span> Exportar
                    </button>
                    <button class="dropdown-item" onclick="document.getElementById('importFile').click(); closeDropdown('actionsDropdown')">
                        <span>📤</span> Importar
                    </button>
                </div>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)">
        </div>

        <div class="controls-right">
            <span class="filter-label">📂 Filtrar:</span>
            <select class="filter-dropdown" id="templateFilter" onchange="filterByTemplate(this.value)">
                <option value="all">Todos os Templates</option>
            </select>
            
            <button class="btn btn-secondary" id="tableToggleBtn" onclick="toggleTableView()">
                <span>📊</span> Mostrar Planilha
            </button>
        </div>
    </div>

    <div class="keyboard-shortcut">
        💡 Dica: Use Alt+N para novo cliente, Escape para fechar modais
    </div>

    <div class="kanban-board" id="kanbanView">
        <div class="column todo" id="todo">
            <h2>🔴 A Fazer</h2>
        </div>
        <div class="column progress" id="progress">
            <h2>🟡 Em Andamento</h2>
        </div>
        <div class="column done" id="done">
            <h2>🟢 Concluído</h2>
        </div>
    </div>

    <div class="table-view hidden" id="tableView">
        <table id="clientsTable">
            <thead>
                <tr>
                    <th></th>
                    <th>Nome do Cliente</th>
                    <th>Template</th>
                    <th>Status</th>
                    <th>Progresso</th>
                    <th>Data de Início</th>
                    <th>Data de Fim</th>
                </tr>
            </thead>
            <tbody id="clientsTableBody">
                </tbody>
        </table>
    </div>

    <div id="newClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👤 Novo Cliente</h2>
                <span class="close" onclick="closeModal('newClientModal')">&times;</span>
            </div>
            <form id="newClientForm">
                <div class="form-group">
                    <label for="clientName">Nome do Cliente:</label>
                    <input type="text" id="clientName" placeholder="Digite o nome do cliente" required>
                </div>
                <div class="form-group">
                    <label>Selecione um Template:</label>
                    <div class="templates-list" id="templatesList">
                        </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('newClientModal')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn">
                        <span>✅</span> Criar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Gerenciar Templates</h2>
                <span class="close" onclick="closeModal('templateModal')">&times;</span>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('myTemplates')">Meus Templates</button>
                    <button class="tab-button" onclick="switchTab('templateEditor')">Editor de Template</button>
                </div>

                <div id="myTemplates" class="tab-content active">
                    <div class="templates-list">
                        <div id="existingTemplates">
                            </div>
                    </div>
                </div>

                <div id="templateEditor" class="tab-content">
                    <div class="template-builder">
                        <h3 id="editorTitle">➕ Criar Novo Template</h3>
                        <div class="form-group">
                            <label for="templateName">Nome do Template:</label>
                            <input type="text" id="templateName" placeholder="Ex: Onboarding Shopify">
                        </div>
                        <div class="form-group">
                            <label>Perguntas do Checklist:</label>
                            <div class="template-items-container">
                                <div id="templateItems">
                                    <div class="template-question-block">
                                        <button type="button" class="template-remove-btn" onclick="removeTemplateItem(this)">🗑️</button>
                                        <div class="template-item">
                                            <input type="text" placeholder="Digite uma pergunta..." required>
                                            <select onchange="handleTypeChange(this)">
                                                <option value="checkbox">Sim/Não</option>
                                                <option value="text">Texto</option>
                                                <option value="textarea">Texto Longo</option>
                                                <option value="date">Data</option>
                                                <option value="number">Número</option>
                                                <option value="url">Link</option>
                                                <option value="select">Lista de Opções</option>
                                                <option value="observacoes">Campo de Observações</option>
                                            </select>
                                        </div>
                                        <div class="template-item-controls">
                                            <div class="required-checkbox">
                                                <input type="checkbox" id="req-new-0">
                                                <label for="req-new-0">Obrigatório</label>
                                            </div>
                                            <div class="drag-handle">⠿</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addTemplateItem()">
                                ➕ Adicionar Pergunta
                            </button>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="button" class="btn" onclick="saveTemplate()">
                                <span>💾</span> Salvar Template
                            </button>
                            <button type="button" class="btn btn-ghost" onclick="cancelTemplateEdit()">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions" id="templateModalActions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('templateModal')">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="checklistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="checklistTitle">Checklist do Cliente</h2>
                <span class="close" onclick="closeModal('checklistModal')">&times;</span>
            </div>
            <div id="checklistContent"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="duplicateClient()">
                    <span>📋</span> Duplicar
                </button>
                <button class="btn btn-danger" onclick="deleteClient()">
                    <span>🗑️</span> Excluir
                </button>
                <button class="btn btn-secondary" onclick="closeModal('checklistModal')">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <footer class="footer">
        Desenvolvido por <a href="https://github.com/vininleao" target="_blank">Vinícius Leão</a>
    </footer>

    <script>
        // Templates pré-definidos
        const defaultTemplates = {
            'onboarding-amazon': {
                name: 'Onboarding Amazon',
                items: [
                    { id: 'conta-amazon', text: 'Abriu conta Amazon?', type: 'checkbox', isRequired: true },
                    { id: 'pagamento', text: 'Método de pagamento confirmado?', type: 'checkbox', isRequired: true },
                    { id: 'produtos', text: 'Subiu produtos?', type: 'checkbox', isRequired: false },
                    { id: 'quantidade-produtos', text: 'Quantos produtos?', type: 'number', isRequired: false },
                    { id: 'observacoes', text: 'Observações', type: 'observacoes', isRequired: false }
                ],
                isDefault: true
            }
        };

        // Dados globais
        let clients = [];
        let templates = {};
        let currentClientId = null;
        let selectedTemplateId = null;
        let editingTemplateId = null;
        let currentFilter = 'all';
        let tableVisible = false;
        let expandedClientIds = new Set();
        let currentEditingRow = null;
        let templateSortable = null;
        let originalFieldState = null; // Para armazenar estado original na edição

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderClients();
            renderTableView();
            updateStats();
            renderTemplateFilters();
            setupDragAndDrop();
            setupSearch();
            setupKeyboardShortcuts();
            setupDropdowns();
        });

        // Configurar dropdowns
        function setupDropdowns() {
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                    document.querySelectorAll('.dropdown-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                }
            });
        }

        // Alternar dropdown
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const btn = document.getElementById(id + 'Btn');
            const isOpen = dropdown.classList.contains('show');
            
            // Fechar todos os dropdowns
            document.querySelectorAll('.dropdown-content').forEach(dd => dd.classList.remove('show'));
            document.querySelectorAll('.dropdown-btn').forEach(b => b.classList.remove('active'));
            
            if (!isOpen) {
                dropdown.classList.add('show');
                btn.classList.add('active');
            }
        }

        // Fechar dropdown
                function closeDropdown(id) {
            const dropdown = document.getElementById(id);
            const btn = document.getElementById(id + 'Btn');
            dropdown.classList.remove('show');
            btn.classList.remove('active');
        }

        // Alternar abas
        function switchTab(tabName) {
            // Remover classe ativa de todos os botões e conteúdos
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Controlar visibilidade do botão "Fechar" no rodapé
            const modalActions = document.getElementById('templateModalActions');
            if (tabName === 'templateEditor') {
                modalActions.style.display = 'none';
                // Inicializar sortable para novos templates se não estiver editando
                if (!editingTemplateId) {
                    initTemplateSortable();
                }
            } else {
                modalActions.style.display = 'flex';
                loadExistingTemplates();
            }
        }

        // Configurar atalhos de teclado
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.altKey && e.key === 'n') {
                    e.preventDefault();
                    openNewClientModal();
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    if (currentEditingRow) {
                        cancelInlineEdit();
                    }
                    document.querySelectorAll('.modal').forEach(modal => {
                        if (modal.style.display === 'block') {
                            modal.style.display = 'none';
                        }
                    });
                }
                if (e.key === 'Enter' && e.ctrlKey) {
                    const activeModal = Array.from(document.querySelectorAll('.modal')).find(modal => 
                        modal.style.display === 'block'
                    );
                    if (activeModal) {
                        const submitBtn = activeModal.querySelector('button[type="submit"], .btn:not(.btn-secondary):not(.btn-danger):not(.btn-ghost)');
                        if (submitBtn) {
                            submitBtn.click();
                        }
                    }
                }
            });
        }

        // Alternar visibilidade da tabela
        function toggleTableView() {
            const tableView = document.getElementById('tableView');
            const toggleBtn = document.getElementById('tableToggleBtn');

            tableVisible = !tableVisible;
            
            if (tableVisible) {
                tableView.classList.remove('hidden');
                toggleBtn.innerHTML = '<span>📋</span> Ocultar Planilha';
            } else {
                tableView.classList.add('hidden');
                toggleBtn.innerHTML = '<span>📊</span> Mostrar Planilha';
            }
        }

        // Renderizar filtros de template
        function renderTemplateFilters() {
            const dropdown = document.getElementById('templateFilter');
            
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }

            Object.keys(templates).forEach(templateId => {
                const template = templates[templateId];
                const option = document.createElement('option');
                option.value = templateId;
                option.textContent = template.name;
                if (templateId === currentFilter) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });

            dropdown.value = currentFilter;
        }

        // Filtrar por template
        function filterByTemplate(templateId) {
            currentFilter = templateId;
            renderClients();
            renderTableView();
            updateStats();
        }

        // Validar campos obrigatórios
        function validateRequiredFields(client) {
            const template = templates[client.template];
            if (!template) return { valid: true, missing: [] };

            const missing = [];
            
            template.items.forEach(item => {
                if (item.isRequired) {
                    const response = client.responses[item.id];
                    
                    if (item.type === 'checkbox') {
                        if (!response) missing.push(item.text);
                    } else {
                        if (!response || response.toString().trim() === '') {
                            missing.push(item.text);
                        }
                    }
                }
            });

            return {
                valid: missing.length === 0,
                missing: missing
            };
        }

        // Função para lidar com mudança de tipo no template
        function handleTypeChange(selectElement) {
            const questionBlock = selectElement.closest('.template-question-block');
            const textInput = questionBlock.querySelector('input[type="text"]');
            const existingOptionsInput = questionBlock.querySelector('.options-input');
            
            if (existingOptionsInput) {
                existingOptionsInput.remove();
            }

            if (selectElement.value === 'observacoes') {
                textInput.value = 'Observações';
                textInput.disabled = true;
            } else {
                textInput.disabled = false;
                if (textInput.value === 'Observações') {
                    textInput.value = '';
                }
            }

            if (selectElement.value === 'select') {
                const optionsInput = document.createElement('input');
                optionsInput.type = 'text';
                optionsInput.className = 'options-input';
                optionsInput.placeholder = 'Digite as opções separadas por vírgula (ex: Opção A, Opção B, Opção C)';
                
                const templateItem = selectElement.closest('.template-item');
                questionBlock.insertBefore(optionsInput, questionBlock.querySelector('.template-item-controls'));
            }
        }

        // Função para expandir/recolher detalhes do cliente na tabela
        function toggleClientDetails(clientId, event) {
            if (event && event.target.classList.contains('expand-btn')) {
                return;
            }
            
            const detailRows = document.querySelectorAll(`[data-parent="${clientId}"]`);
            const expandBtn = document.querySelector(`[data-client-id="${clientId}"] .expand-btn`);
            const isExpanded = expandBtn.classList.contains('expanded');
            
            detailRows.forEach(row => {
                if (isExpanded) {
                    row.classList.remove('expanded');
                } else {
                    row.classList.add('expanded');
                }
            });
            
            if (isExpanded) {
                expandBtn.classList.remove('expanded');
                expandBtn.textContent = '+';
                expandedClientIds.delete(clientId);
            } else {
                expandBtn.classList.add('expanded');
                expandBtn.textContent = '−';
                expandedClientIds.add(clientId);
            }
        }

        // Função para formatar datas no padrão brasileiro
        function formatDateBR(dateString) {
            if (!dateString || !dateString.includes('-')) return 'Não preenchido';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        }

        // Nova função de edição inline corrigida
        function enableInlineEdit(element, clientId, itemId, itemType) {
            if (currentEditingRow && currentEditingRow !== element) {
                cancelInlineEdit();
            }

            if (currentEditingRow === element) {
                return;
            }

            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            currentEditingRow = element;
            const originalLastEditedDiv = element.querySelector('.last-edited[data-original="true"]');
            
            // Salvar estado original para cancelamento
            originalFieldState = {
                answerHtml: element.querySelector('.checklist-answer').innerHTML,
                lastEditedHtml: originalLastEditedDiv ? originalLastEditedDiv.outerHTML : null,
                detailRowClasses: element.closest('.detail-row').className
            };

            const detailRow = element.closest('.detail-row');
            detailRow.classList.add('editing');

            const currentValue = client.responses[itemId] || '';
            const questionDiv = element.querySelector('.checklist-question');
            const answerDiv = element.querySelector('.checklist-answer');
            
            answerDiv.style.display = 'none';
            if (originalLastEditedDiv) {
                originalLastEditedDiv.style.display = 'none';
            }
            
            if (!questionDiv.querySelector('.editing-indicator')) {
                const indicator = document.createElement('span');
                indicator.className = 'editing-indicator';
                indicator.textContent = '(editando...)';
                questionDiv.appendChild(indicator);
            }
            
            let input;
            
            if (itemType === 'checkbox') {
                input = document.createElement('input');
                input.type = 'checkbox';
                input.checked = currentValue;
                input.className = 'inline-edit-checkbox';
            } else if (itemType === 'select') {
                const template = templates[client.template];
                const item = template.items.find(i => i.id === itemId);
                
                input = document.createElement('select');
                input.className = 'inline-edit-select';
                
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Selecione...';
                input.appendChild(emptyOption);
                
                if (item.options) {
                    item.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        if (option === currentValue) opt.selected = true;
                        input.appendChild(opt);
                    });
                }
            } else if (itemType === 'observacoes') {
                input = document.createElement('textarea');
                input.value = currentValue;
                input.className = 'inline-edit';
                input.placeholder = 'Digite suas observações...';
                input.style.minHeight = '80px';
                input.style.width = '100%';
                input.style.maxWidth = '400px';
            } else {
                input = document.createElement('input');
                input.type = itemType === 'textarea' ? 'text' : itemType;
                input.value = currentValue;
                input.className = 'inline-edit';
                input.placeholder = 'Digite aqui...';
            }

            const saveEdit = () => {
                let newValue;
                if (itemType === 'checkbox') {
                    newValue = input.checked;
                } else {
                    newValue = input.value;
                }
                
                client.responses[itemId] = newValue;
                
                if (itemType === 'observacoes' && newValue && newValue.toString().trim() !== '') {
                    client.observationLastEdited = new Date().toISOString();
                }
                
                updateStatusByProgress(client);
                
                saveData();
                renderClients();
                renderTableViewPreservingState();
                updateStats();
                
                currentEditingRow = null;
                originalFieldState = null;
            };

            const cancelEdit = () => {
                cancelInlineEdit();
            };

            // Criar container com botões de ação
            const container = document.createElement('div');
            container.className = 'inline-edit-container';
            
            container.appendChild(input);
            
            if (itemType !== 'checkbox') {
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn btn-mini btn-save';
                saveBtn.innerHTML = '✔️';
                saveBtn.onclick = (e) => {
                    e.stopPropagation();
                    saveEdit();
                };
                saveBtn.title = 'Salvar';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-mini btn-ghost';
                cancelBtn.innerHTML = '❌';
                cancelBtn.onclick = (e) => {
                    e.stopPropagation();
                    cancelEdit();
                };
                cancelBtn.title = 'Cancelar';
                
                container.appendChild(saveBtn);
                container.appendChild(cancelBtn);
            }

            // Para campos de observações, preservar informação de última edição
            if (itemType === 'observacoes' && client.observationLastEdited) {
                 const editedInfo = document.createElement('div');
                 editedInfo.className = 'last-edited editing-last-edited';
                 editedInfo.textContent = `Última edição: ${formatDateTime(client.observationLastEdited)}`;
                 container.appendChild(editedInfo);
            }

            input.onblur = () => {
                if (itemType === 'checkbox') {
                    saveEdit();
                }
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter' && itemType !== 'observacoes') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            };

            element.appendChild(container);
            input.focus();
        }

        // Cancelar edição inline corrigida
        function cancelInlineEdit() {
            if (!currentEditingRow || !originalFieldState) return;

            const detailRow = currentEditingRow.closest('.detail-row');
            const questionDiv = currentEditingRow.querySelector('.checklist-question');
            const answerDiv = currentEditingRow.querySelector('.checklist-answer');
            const container = currentEditingRow.querySelector('.inline-edit-container');
            const editingIndicator = questionDiv.querySelector('.editing-indicator');
            const originalLastEditedDiv = currentEditingRow.querySelector('.last-edited[data-original="true"]');

            // Restaurar estado original
            detailRow.className = originalFieldState.detailRowClasses;
            answerDiv.innerHTML = originalFieldState.answerHtml;
            answerDiv.style.display = 'block';

            if (originalLastEditedDiv) {
                originalLastEditedDiv.style.display = '';
            }

            // Remover elementos de edição
            if (editingIndicator) {
                editingIndicator.remove();
            }

            if (container) {
                container.remove();
            }
            
            currentEditingRow = null;
            originalFieldState = null;
        }

        // Nova função para renderizar a tabela preservando o estado de expansão
        function renderTableViewPreservingState() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            const filteredClients = currentFilter === 'all' 
                ? clients 
                : clients.filter(c => c.template === currentFilter);

            filteredClients.forEach(client => {
                const template = templates[client.template];
                if (!template) return;

                const progress = calculateProgress(client);
                
                const clientRow = document.createElement('tr');
                clientRow.className = 'client-row';
                clientRow.dataset.clientId = client.id;
                clientRow.setAttribute('data-client-id', client.id);
                clientRow.onclick = (e) => toggleClientDetails(client.id, e);

                const statusLabels = {
                    'todo': 'A Fazer',
                    'progress': 'Em Andamento',
                    'done': 'Concluído'
                };

                const isExpanded = expandedClientIds.has(client.id);
                const expandIcon = isExpanded ? '−' : '+';

                clientRow.innerHTML = `
                    <td>
                        <button class="expand-btn ${isExpanded ? 'expanded' : ''}">${expandIcon}</button>
                    </td>
                    <td>${client.name}</td>
                    <td>${template.name}</td>
                    <td><span class="status-badge status-${client.status}">${statusLabels[client.status]}</span></td>
                    <td>
                        <div class="progress-cell">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: ${progress}%"></div>
                            </div>
                            <span>${progress}%</span>
                        </div>
                    </td>
                    <td>${formatDate(client.createdAt)}</td>
                    <td>${formatDate(client.completedAt)}</td>
                `;

                tbody.appendChild(clientRow);

                template.items.forEach(item => {
                    const detailRow = document.createElement('tr');
                    detailRow.className = `detail-row ${isExpanded ? 'expanded' : ''}`;
                    detailRow.dataset.parent = client.id;

                    let answerContent = '';
                    let answerClass = '';
                    const response = client.responses[item.id];

                    if (item.type === 'checkbox') {
                        if (response === true) {
                            answerContent = '✅ Sim';
                            answerClass = 'completed';
                        } else {
                            answerContent = '❌ Não';
                            answerClass = 'incomplete';
                        }
                    } else if (item.type === 'date' && response) {
                        answerContent = formatDateBR(response);
                        answerClass = 'completed';
                    } else {
                        answerContent = response || 'Não preenchido';
                        answerClass = response ? 'completed' : 'incomplete';
                    }

                    // Criar conteúdo especial para campo de observações
                    let detailContent = '';
                    if (item.type === 'observacoes') {
                        const lastEdited = client.observationLastEdited 
                            ? formatDateTime(client.observationLastEdited)
                            : null;
                        
                        detailContent = `
                            <div class="detail-content">
                                <div>
                                    <div class="checklist-question">${item.text}${item.isRequired ? ' *' : ''}</div>
                                </div>
                                <div>
                                    <div class="checklist-answer ${answerClass}">${answerContent}</div>
                                    ${lastEdited ? `<div class="last-edited" data-original="true">Última edição: ${lastEdited}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        detailContent = `
                            <div class="detail-content">
                                <div>
                                    <div class="checklist-question">${item.text}${item.isRequired ? ' *' : ''}</div>
                                </div>
                                <div>
                                    <div class="checklist-answer ${answerClass}">${answerContent}</div>
                                </div>
                            </div>
                        `;
                    }

                    detailRow.innerHTML = `
                        <td colspan="7" onclick="enableInlineEdit(this, ${client.id}, '${item.id}', '${item.type}')">
                            ${detailContent}
                        </td>
                    `;

                    tbody.appendChild(detailRow);
                });
            });
        }

        // Renderizar visão de tabela
        function renderTableView() {
            renderTableViewPreservingState();
        }

        // Carregar dados do localStorage
        function loadData() {
            const storedClients = localStorage.getItem('clientdeck-clients');
            const storedTemplates = localStorage.getItem('clientdeck-templates');
            
            if (storedClients) {
                clients = JSON.parse(storedClients);
                clients.forEach(client => {
                    if (!client.completedAt) client.completedAt = null;
                    if (!client.observationLastEdited) client.observationLastEdited = null;
                });
            }
            
            if (storedTemplates) {
                templates = JSON.parse(storedTemplates);
                Object.keys(templates).forEach(templateId => {
                    const template = templates[templateId];
                    template.items.forEach(item => {
                        if (item.isRequired === undefined) {
                            item.isRequired = false;
                        }
                    });
                });
            } else {
                templates = { ...defaultTemplates };
                saveTemplates();
            }
        }

        // Salvar dados
        function saveData() {
            localStorage.setItem('clientdeck-clients', JSON.stringify(clients));
        }

        function saveTemplates() {
            localStorage.setItem('clientdeck-templates', JSON.stringify(templates));
        }

        // Configurar busca
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.querySelector('.clear-search');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                clearButton.style.display = query ? 'block' : 'none';
                filterClients(query);
            });
        }

        // Filtrar clientes
        function filterClients(query) {
            const cards = document.querySelectorAll('.card');
            const rows = document.querySelectorAll('#clientsTableBody tr.client-row');
            
            cards.forEach(card => {
                const clientName = card.querySelector('h3').textContent.toLowerCase();
                const templateName = card.querySelector('.template-name').textContent.toLowerCase();
                const matches = clientName.includes(query) || templateName.includes(query);
                card.style.display = matches ? 'block' : 'none';
            });

            rows.forEach(row => {
                const clientName = row.cells[1].textContent.toLowerCase();
                const templateName = row.cells[2].textContent.toLowerCase();
                const matches = clientName.includes(query) || templateName.includes(query);
                const clientId = row.dataset.clientId;
                
                row.style.display = matches ? '' : 'none';
                
                const detailRows = document.querySelectorAll(`[data-parent="${clientId}"]`);
                detailRows.forEach(detailRow => {
                    detailRow.style.display = matches ? '' : 'none';
                });
            });
        }

        // Limpar busca
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.querySelector('.clear-search').style.display = 'none';
            filterClients('');
        }

        // Mostrar toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${isError ? 'error' : ''} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Formatar data para exibição
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        // Formatar data e hora para exibição
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Abrir modal de novo cliente
        function openNewClientModal() {
            document.getElementById('newClientModal').style.display = 'block';
            loadTemplatesForSelection();
            setTimeout(() => {
                document.getElementById('clientName').focus();
            }, 100);
        }

        // Carregar templates para seleção
        function loadTemplatesForSelection() {
            const container = document.getElementById('templatesList');
            container.innerHTML = '';

            Object.keys(templates).forEach(key => {
                const template = templates[key];
                const div = document.createElement('div');
                div.className = 'template-card';
                div.onclick = () => selectTemplate(key, div);
                
                div.innerHTML = `
                    <h4>${template.name}</h4>
                    <p>${template.items.length} pergunta${template.items.length !== 1 ? 's' : ''}</p>
                `;
                
                container.appendChild(div);
            });
        }

        // Selecionar template
        function selectTemplate(templateId, element) {
            document.querySelectorAll('#templatesList .template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedTemplateId = templateId;
        }

        // Fechar modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            selectedTemplateId = null;
            editingTemplateId = null;
        }

        // Criar novo cliente
        document.getElementById('newClientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('clientName').value.trim();
            
            if (!name || !selectedTemplateId) {
                showToast('❌ Preencha o nome e selecione um template', true);
                return;
            }

            const client = {
                id: Date.now(),
                name: name,
                template: selectedTemplateId,
                status: 'todo',
                responses: {},
                createdAt: new Date().toISOString(),
                completedAt: null,
                observationLastEdited: null
            };

            clients.push(client);
            saveData();
            renderClients();
            renderTableViewPreservingState();
            updateStats();
            renderTemplateFilters();
            
            document.getElementById('newClientForm').reset();
            closeModal('newClientModal');
            showToast('✅ Cliente criado com sucesso!');
        });

        // Renderizar clientes com mensagens de estado vazio
        function renderClients() {
            ['todo', 'progress', 'done'].forEach(status => {
                const column = document.getElementById(status);
                const cards = column.querySelectorAll('.card, .empty-state');
                cards.forEach(card => card.remove());
            });

            const filteredClients = currentFilter === 'all' 
                ? clients 
                : clients.filter(c => c.template === currentFilter);

            // Agrupar clientes por status
            const clientsByStatus = {
                todo: filteredClients.filter(c => c.status === 'todo'),
                progress: filteredClients.filter(c => c.status === 'progress'),
                done: filteredClients.filter(c => c.status === 'done')
            };

            // Renderizar clientes ou mensagem de estado vazio
            ['todo', 'progress', 'done'].forEach(status => {
                const column = document.getElementById(status);
                const statusClients = clientsByStatus[status];
                
                if (statusClients.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = 'Nenhum cliente aqui.';
                    column.appendChild(emptyState);
                } else {
                    statusClients.forEach(client => {
                        const card = createCardElement(client);
                        column.appendChild(card);
                    });
                }
            });
        }

        // Criar elemento de card
        function createCardElement(client) {
            const card = document.createElement('div');
            card.className = 'card';
            card.draggable = true;
            card.dataset.clientId = client.id;

            const template = templates[client.template];
            if (!template) {
                console.warn(`Template ${client.template} não encontrado`);
                return card;
            }

            const progress = calculateProgress(client);
            const createdDate = formatDate(client.createdAt);
            const completedDate = formatDate(client.completedAt);

            card.innerHTML = `
                <h3>${client.name}</h3>
                <div class="template-name">${template.name}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="progress-text">${progress}% completo</div>
                <div class="card-meta">
                    <span>📝 ${template.items.length} itens</span>
                </div>
                <div class="dates-info">
                    <div>📅 Início: ${createdDate}</div>
                    ${client.completedAt ? `<div>✅ Fim: ${completedDate}</div>` : ''}
                </div>
            `;

            card.addEventListener('click', () => openChecklistModal(client.id));
            
            return card;
        }

        // Calcular progresso corrigido - baseado apenas em campos obrigatórios
        function calculateProgress(client) {
            const template = templates[client.template];
            if (!template) return 0;
            
            const requiredItems = template.items.filter(item => item.isRequired);
            
            // Se não há campos obrigatórios, progresso é 100%
            if (requiredItems.length === 0) return 100;
            
            const completedItems = requiredItems.filter(item => {
                const response = client.responses[item.id];
                
                if (item.type === 'checkbox') {
                    return response === true;
                } else {
                    return response && response.toString().trim() !== '';
                }
            });
            
            return Math.round((completedItems.length / requiredItems.length) * 100);
        }

        // Função para atualizar status automaticamente baseado no progresso
        function updateStatusByProgress(client) {
            const progress = calculateProgress(client);
            let newStatus = client.status;
            
            if (progress === 100) {
                newStatus = 'done';
                if (!client.completedAt) {
                    client.completedAt = new Date().toISOString();
                }
            } else if (progress > 0) {
                newStatus = 'progress';
                client.completedAt = null;
            } else {
                newStatus = 'todo';
                client.completedAt = null;
            }

            if (client.status !== newStatus) {
                const statusNames = {
                    'todo': 'A Fazer',
                    'progress': 'Em Andamento',
                    'done': 'Concluído'
                };
                
                client.status = newStatus;
                showToast(`🔄 ${client.name} movido automaticamente para "${statusNames[newStatus]}"`);
                return true;
            }
            
            return false;
        }

        // Criar input baseado no tipo
        function createInputByType(item, value = '') {
            let input = '';
            
            switch (item.type) {
                case 'checkbox':
                    input = `<input type="checkbox" id="${item.id}" ${value ? 'checked' : ''} onchange="updateResponse('${item.id}', this.checked)">`;
                    break;
                case 'textarea':
                    input = `<textarea id="${item.id}" placeholder="Digite aqui..." onchange="updateResponse('${item.id}', this.value)">${value}</textarea>`;
                    break;
                case 'observacoes':
                    input = `<textarea id="${item.id}" placeholder="Digite suas observações..." onchange="updateResponse('${item.id}', this.value)">${value}</textarea>`;
                    break;
                case 'date':
                    input = `<input type="date" id="${item.id}" value="${value}" onchange="updateResponse('${item.id}', this.value)">`;
                    break;
                case 'number':
                    input = `<input type="number" id="${item.id}" placeholder="Digite um número..." value="${value}" onchange="updateResponse('${item.id}', this.value)">`;
                    break;
                case 'url':
                    input = `<input type="url" id="${item.id}" placeholder="Digite uma URL..." value="${value}" onchange="updateResponse('${item.id}', this.value)">`;
                    break;
                case 'select':
                    let options = '<option value="">Selecione...</option>';
                    if (item.options) {
                        item.options.forEach(option => {
                            const selected = option === value ? 'selected' : '';
                            options += `<option value="${option}" ${selected}>${option}</option>`;
                        });
                    }
                    input = `<select id="${item.id}" onchange="updateResponse('${item.id}', this.value)">${options}</select>`;
                    break;
                default:
                    input = `<input type="text" id="${item.id}" placeholder="Digite aqui..." value="${value}" onchange="updateResponse('${item.id}', this.value)">`;
            }
            
            return input;
        }

        // Abrir modal de checklist
        function openChecklistModal(clientId) {
            currentClientId = clientId;
            const client = clients.find(c => c.id === clientId);
            const template = templates[client.template];

            if (!template) {
                showToast('❌ Template não encontrado', true);
                return;
            }

            document.getElementById('checklistTitle').textContent = `${client.name} - ${template.name}`;
            
            const content = document.getElementById('checklistContent');
            content.innerHTML = '';

            template.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'checklist-item';

                const value = client.responses[item.id] || '';
                const input = createInputByType(item, value);
                const requiredLabel = item.isRequired ? ' <span style="color: #f85149;">*</span>' : '';

                // Adicionar informação de última edição para campo de observações
                let lastEditedInfo = '';
                if (item.type === 'observacoes' && client.observationLastEdited) {
                    lastEditedInfo = `<div class="last-edited">Última edição: ${formatDateTime(client.observationLastEdited)}</div>`;
                }

                div.innerHTML = `
                    <label>
                        ${item.type === 'checkbox' ? input : ''}
                        ${item.text}${requiredLabel}
                    </label>
                    ${item.type !== 'checkbox' ? input : ''}
                    ${lastEditedInfo}
                `;

                content.appendChild(div);
            });

            document.getElementById('checklistModal').style.display = 'block';
        }

        // Atualizar resposta
        function updateResponse(itemId, value) {
            const client = clients.find(c => c.id === currentClientId);
            if (client) {
                client.responses[itemId] = value;
                
                const template = templates[client.template];
                const item = template.items.find(i => i.id === itemId);
                
                if (item && item.type === 'observacoes' && value && value.toString().trim() !== '') {
                    client.observationLastEdited = new Date().toISOString();
                }
                
                updateStatusByProgress(client);
                
                saveData();
                renderClients();
                renderTableViewPreservingState();
                updateStats();
            }
        }

        // Duplicar cliente
        function duplicateClient() {
            const client = clients.find(c => c.id === currentClientId);
            if (client) {
                const newClient = {
                    ...client,
                    id: Date.now(),
                    name: client.name + ' (Cópia)',
                    status: 'todo',
                    responses: {},
                    createdAt: new Date().toISOString(),
                    completedAt: null,
                    observationLastEdited: null
                };
                
                clients.push(newClient);
                saveData();
                renderClients();
                renderTableViewPreservingState();
                updateStats();
                renderTemplateFilters();
                closeModal('checklistModal');
                showToast('✅ Cliente duplicado com sucesso!');
            }
        }

        // Excluir cliente
        function deleteClient() {
            if (confirm('❌ Tem certeza que deseja excluir este cliente?')) {
                clients = clients.filter(c => c.id !== currentClientId);
                saveData();
                renderClients();
                renderTableViewPreservingState();
                updateStats();
                renderTemplateFilters();
                closeModal('checklistModal');
                showToast('✅ Cliente excluído com sucesso!');
            }
        }

        // Abrir modal de templates
        function openTemplateModal() {
            document.getElementById('templateModal').style.display = 'block';
            switchTab('myTemplates');
        }

        // Carregar templates existentes
        function loadExistingTemplates() {
            const container = document.getElementById('existingTemplates');
            container.innerHTML = '';

            Object.keys(templates).forEach(key => {
                const template = templates[key];
                const div = document.createElement('div');
                div.className = 'template-card';
                
                div.innerHTML = `
                    <h4>${template.name}</h4>
                    <p>${template.items.length} pergunta${template.items.length !== 1 ? 's' : ''}</p>
                    <div class="template-actions">
                        <button class="btn btn-secondary btn-small" onclick="editTemplate('${key}')">
                            ✏️ Editar
                        </button>
                        ${!template.isDefault ? `
                            <button class="btn btn-ghost-danger btn-small" onclick="deleteTemplate('${key}')">
                                🗑️ Excluir
                            </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // Editar template
        function editTemplate(templateId) {
            editingTemplateId = templateId;
            const template = templates[templateId];
            
            document.getElementById('editorTitle').textContent = '✏️ Editar Template';
            document.getElementById('templateName').value = template.name;
            
            const container = document.getElementById('templateItems');
            container.innerHTML = '';
            
            template.items.forEach((item, index) => {
                const questionBlock = document.createElement('div');
                questionBlock.className = 'template-question-block';
                
                const optionsInput = item.type === 'select' && item.options ? 
                    `<input type="text" class="options-input" value="${item.options.join(', ')}" placeholder="Digite as opções separadas por vírgula">` : '';
                
                const isDisabled = item.type === 'observacoes' ? 'disabled' : '';
                
                questionBlock.innerHTML = `
                    <button type="button" class="template-remove-btn" onclick="removeTemplateItem(this)">🗑️</button>
                    <div class="template-item">
                        <input type="text" value="${item.text}" ${isDisabled} required>
                        <select onchange="handleTypeChange(this)">
                            <option value="checkbox" ${item.type === 'checkbox' ? 'selected' : ''}>Sim/Não</option>
                            <option value="text" ${item.type === 'text' ? 'selected' : ''}>Texto</option>
                            <option value="textarea" ${item.type === 'textarea' ? 'selected' : ''}>Texto Longo</option>
                            <option value="date" ${item.type === 'date' ? 'selected' : ''}>Data</option>
                            <option value="number" ${item.type === 'number' ? 'selected' : ''}>Número</option>
                            <option value="url" ${item.type === 'url' ? 'selected' : ''}>Link</option>
                            <option value="select" ${item.type === 'select' ? 'selected' : ''}>Lista de Opções</option>
                            <option value="observacoes" ${item.type === 'observacoes' ? 'selected' : ''}>Campo de Observações</option>
                        </select>
                    </div>
                    ${optionsInput}
                    <div class="template-item-controls">
                        <div class="required-checkbox">
                            <input type="checkbox" id="req-edit-${index}" ${item.isRequired ? 'checked' : ''}>
                            <label for="req-edit-${index}">Obrigatório</label>
                        </div>
                        <div class="drag-handle">⠿</div>
                    </div>
                `;
                
                container.appendChild(questionBlock);
            });
            
            // Inicializar drag and drop para reordenação
            initTemplateSortable();
            
            switchTab('templateEditor');
        }

        // Inicializar SortableJS para reordenação de templates
        function initTemplateSortable() {
            if (templateSortable) {
                templateSortable.destroy();
            }
            
            const container = document.getElementById('templateItems');
            templateSortable = new Sortable(container, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    // Para novos templates, apenas salvar quando o template for salvo
                    if (editingTemplateId && templates[editingTemplateId]) {
                        const template = templates[editingTemplateId];
                        const movedItem = template.items.splice(evt.oldIndex, 1)[0];
                        template.items.splice(evt.newIndex, 0, movedItem);
                        saveTemplates();
                        showToast('✅ Ordem das perguntas atualizada!');
                    }
                }
            });
        }

        // Cancelar edição de template
        function cancelTemplateEdit() {
            editingTemplateId = null;
            document.getElementById('editorTitle').textContent = '➕ Criar Novo Template';
            document.getElementById('templateName').value = '';
            resetTemplateItems();
            if (templateSortable) {
                templateSortable.destroy();
                templateSortable = null;
            }
            switchTab('myTemplates');
        }

        // Reset template items
        function resetTemplateItems() {
            document.getElementById('templateItems').innerHTML = `
                <div class="template-question-block">
                    <button type="button" class="template-remove-btn" onclick="removeTemplateItem(this)">🗑️</button>
                    <div class="template-item">
                        <input type="text" placeholder="Digite uma pergunta..." required>
                        <select onchange="handleTypeChange(this)">
                            <option value="checkbox">Sim/Não</option>
                            <option value="text">Texto</option>
                            <option value="textarea">Texto Longo</option>
                            <option value="date">Data</option>
                            <option value="number">Número</option>
                            <option value="url">Link</option>
                            <option value="select">Lista de Opções</option>
                            <option value="observacoes">Campo de Observações</option>
                        </select>
                    </div>
                    <div class="template-item-controls">
                        <div class="required-checkbox">
                            <input type="checkbox" id="req-new-0">
                            <label for="req-new-0">Obrigatório</label>
                        </div>
                        <div class="drag-handle">⠿</div>
                    </div>
                </div>
            `;
            
            // Inicializar sortable para novos templates também
            setTimeout(() => {
                initTemplateSortable();
            }, 100);
        }

        // Adicionar item ao template
        function addTemplateItem() {
            const container = document.getElementById('templateItems');
            const itemCount = container.children.length;
            const questionBlock = document.createElement('div');
            questionBlock.className = 'template-question-block';
            
            questionBlock.innerHTML = `
                <button type="button" class="template-remove-btn" onclick="removeTemplateItem(this)">🗑️</button>
                <div class="template-item">
                    <input type="text" placeholder="Digite uma pergunta..." required>
                    <select onchange="handleTypeChange(this)">
                        <option value="checkbox">Sim/Não</option>
                        <option value="text">Texto</option>
                        <option value="textarea">Texto Longo</option>
                        <option value="date">Data</option>
                        <option value="number">Número</option>
                        <option value="url">Link</option>
                        <option value="select">Lista de Opções</option>
                        <option value="observacoes">Campo de Observações</option>
                    </select>
                </div>
                <div class="template-item-controls">
                    <div class="required-checkbox">
                        <input type="checkbox" id="req-new-${itemCount}">
                        <label for="req-new-${itemCount}">Obrigatório</label>
                    </div>
                    <div class="drag-handle">⠿</div>
                </div>
            `;
            
            container.appendChild(questionBlock);
            
            // Reinicializar sortable
            initTemplateSortable();
        }

        // Remover item do template
        function removeTemplateItem(button) {
            const container = button.closest('#templateItems');
            if (container.children.length > 1) {
                button.closest('.template-question-block').remove();
                
                // Reinicializar sortable
                initTemplateSortable();
            } else {
                showToast('❌ Deve haver pelo menos uma pergunta no template', true);
            }
        }

        // Salvar template
        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const items = [];
            
            document.querySelectorAll('#templateItems .template-question-block').forEach((block, index) => {
                const text = block.querySelector('input[type="text"]').value.trim();
                const type = block.querySelector('select').value;
                const isRequired = block.querySelector('input[type="checkbox"]').checked;
                const optionsInput = block.querySelector('.options-input');
                
                if (text) {
                    const itemData = {
                        id: type === 'observacoes' ? 'system_notes_timestamp' : `item-${Date.now()}-${index}`,
                        text: text,
                        type: type,
                        isRequired: isRequired
                    };
                    
                    if (type === 'select' && optionsInput && optionsInput.value) {
                        itemData.options = optionsInput.value.split(',').map(opt => opt.trim()).filter(opt => opt);
                    }
                    
                    items.push(itemData);
                }
            });

            if (!name || items.length === 0) {
                showToast('❌ Preencha o nome e adicione pelo menos uma pergunta', true);
                return;
            }

            if (editingTemplateId) {
                const currentTemplate = templates[editingTemplateId];
                templates[editingTemplateId] = {
                    name: name,
                    items: items,
                    isDefault: currentTemplate?.isDefault || false
                };
                showToast('✅ Template atualizado com sucesso!');
            } else {
                const templateId = `custom-${Date.now()}`;
                templates[templateId] = {
                    name: name,
                    items: items,
                    isDefault: false
                };
                showToast('✅ Template criado com sucesso!');
            }

            saveTemplates();
            loadExistingTemplates();
            renderTemplateFilters();
            
            editingTemplateId = null;
            document.getElementById('editorTitle').textContent = '➕ Criar Novo Template';
            document.getElementById('templateName').value = '';
            resetTemplateItems();
            if (templateSortable) {
                templateSortable.destroy();
                templateSortable = null;
            }
            switchTab('myTemplates');
        }

        // Excluir template
        function deleteTemplate(templateId) {
            if (confirm('❌ Tem certeza que deseja excluir este template?')) {
                const clientsUsingTemplate = clients.filter(c => c.template === templateId);
                
                if (clientsUsingTemplate.length > 0) {
                    showToast(`❌ Não é possível excluir. ${clientsUsingTemplate.length} cliente(s) usando este template.`, true);
                    return;
                }
                
                delete templates[templateId];
                saveTemplates();
                loadExistingTemplates();
                renderTemplateFilters();
                showToast('✅ Template excluído com sucesso!');
            }
        }

        // Atualizar estatísticas
        function updateStats() {
            const filteredClients = currentFilter === 'all' 
                ? clients 
                : clients.filter(c => c.template === currentFilter);
                
            const todoCount = filteredClients.filter(c => c.status === 'todo').length;
            const progressCount = filteredClients.filter(c => c.status === 'progress').length;
            const doneCount = filteredClients.filter(c => c.status === 'done').length;

            document.getElementById('todoCount').textContent = todoCount;
            document.getElementById('progressCount').textContent = progressCount;
            document.getElementById('doneCount').textContent = doneCount;
        }

        // Exportar dados
        function exportData() {
            const data = {
                clients: clients,
                templates: templates,
                exportDate: new Date().toISOString(),
                version: '6.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clientdeck-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('✅ Dados exportados com sucesso!');
        }

        // Importar dados
        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.clients && data.templates) {
                        if (confirm('⚠️ Isso substituirá todos os dados atuais. Continuar?')) {
                            clients = data.clients;
                            templates = data.templates;
                            
                            clients.forEach(client => {
                                if (!client.completedAt) client.completedAt = null;
                                if (!client.observationLastEdited) client.observationLastEdited = null;
                            });
                            
                            Object.keys(templates).forEach(templateId => {
                                const template = templates[templateId];
                                template.items.forEach(item => {
                                    if (item.isRequired === undefined) {
                                        item.isRequired = false;
                                    }
                                });
                            });
                            
                            expandedClientIds.clear();
                            currentEditingRow = null;
                            
                            saveData();
                            saveTemplates();
                            renderClients();
                            renderTableViewPreservingState();
                            updateStats();
                            renderTemplateFilters();
                            showToast('✅ Dados importados com sucesso!');
                        }
                    } else {
                        showToast('❌ Arquivo inválido', true);
                    }
                } catch (error) {
                    showToast('❌ Erro ao ler arquivo', true);
                }
            };
            reader.readAsText(file);
            
            input.value = '';
        }

        // Configurar drag and drop
        function setupDragAndDrop() {
            let draggedElement = null;

            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('card')) {
                    draggedElement = e.target;
                    e.target.classList.add('dragging');
                }
            });

            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('card')) {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                }
            });

            ['todo', 'progress', 'done'].forEach(columnId => {
                const column = document.getElementById(columnId);

                column.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });

                column.addEventListener('dragleave', function(e) {
                    if (!column.contains(e.relatedTarget)) {
                        column.classList.remove('drag-over');
                    }
                });

                column.addEventListener('drop', function(e) {
                    e.preventDefault();
                    column.classList.remove('drag-over');

                    if (draggedElement) {
                        const clientId = parseInt(draggedElement.dataset.clientId);
                        const client = clients.find(c => c.id === clientId);
                        
                        if (client && client.status !== columnId) {
                            if (columnId === 'done') {
                                const validation = validateRequiredFields(client);
                                if (!validation.valid) {
                                    showToast(`❌ Preencha todos os campos obrigatórios para concluir: ${validation.missing.join(', ')}`, true);
                                    return;
                                }
                            }
                            
                            const statusNames = {
                                'todo': 'A Fazer',
                                'progress': 'Em Andamento', 
                                'done': 'Concluído'
                            };
                            
                            client.status = columnId;
                            
                            if (columnId === 'done' && !client.completedAt) {
                                client.completedAt = new Date().toISOString();
                            } else if (columnId !== 'done') {
                                client.completedAt = null;
                            }
                            
                            saveData();
                            renderClients();
                            renderTableViewPreservingState();
                            updateStats();
                            showToast(`✅ ${client.name} movido para "${statusNames[columnId]}"`);
                        }
                    }
                });
            });
        }

        // Fechar modais ao clicar fora
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>